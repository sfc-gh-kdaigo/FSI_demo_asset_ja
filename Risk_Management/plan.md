# 📊 リスク管理向けデモ 作業計画

## 🎯 概要

金融機関のリスク管理業務を支援する Snowflake Intelligence デモ環境を構築する。
内部管理用の信用リスク計測と規制資本用の信用リスクアセット計測の両方に対応し、
統一されたデータ基盤上でリスク管理者が迅速に分析・レポート作成できる AI アシスタントを実現。

---

## 🏗️ システム構成イメージ

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         リスク管理システム全体像                              │
└─────────────────────────────────────────────────────────────────────────────┘

【現状の課題（お客様インプット）】
┌─────────────┐     ┌─────────────┐
│ 勘定系システム │     │ 情報系システム │
│ ・貸出金明細  │     │ ・取引先情報  │
│ ・取引先情報  │     │ ・プロダクト  │
└──────┬──────┘     └──────┬──────┘
       │                    │
       │  同じデータを重複保持  │
       │  ↓                  ↓
┌──────────────────────────────────────────────────────────────────────────┐
│   ❌ 各システムでクレンジング・加工を個別実施                              │
│   ❌ 同一データの特定ができない                                           │
│   ❌ 部門情報の紐づけが困難                                               │
└──────────────────────────────────────────────────────────────────────────┘
       │                              │
       ▼                              ▼
┌──────────────────────┐     ┌──────────────────────┐
│ 信用リスク計測システム │     │ 信用リスクアセット計測 │
│    （内部管理用）      │     │  システム（規制資本用） │
│                       │     │                       │
│  貸出金明細 → クレンジング  │  貸出金明細 → クレンジング  │
│  → 計算用データ → リスク計測 │  → 計算用データ → RWA計算   │
│  → EL/UL                   │  → 信用RWA                  │
└──────────────────────┘     └──────────────────────┘

【Snowflakeによる解決策】
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Snowflake 統合データ基盤                           │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────────────────────────┐          │
│  │                    統一マスタデータ                          │          │
│  │  ・DIM_COUNTERPARTY（取引先マスタ）                          │          │
│  │  ・DIM_PRODUCT（プロダクトマスタ）                           │          │
│  │  ・DIM_DEPARTMENT（部門マスタ）← 部門情報を一元管理          │          │
│  │  ・DIM_RATING（格付マスタ）                                  │          │
│  └──────────────────────────────────────────────────────────────┘          │
│                              │                                              │
│                              ▼                                              │
│  ┌──────────────────────────────────────────────────────────────┐          │
│  │                    統一ファクトデータ                        │          │
│  │  ・FACT_LOAN_DETAIL（貸出金明細）← 単一のソース              │          │
│  │  ・FACT_INTERNAL_RISK（内部リスク計測結果）                  │          │
│  │  ・FACT_REGULATORY_RISK（規制資本計算結果）                  │          │
│  └──────────────────────────────────────────────────────────────┘          │
│                              │                                              │
│                              ▼                                              │
│  ┌────────────────────┐  ┌────────────────────┐  ┌────────────────────┐   │
│  │   Semantic View    │  │   Cortex Search    │  │   Cortex Agent     │   │
│  │  ・内部リスク分析   │  │  ・リスク管理規程  │  │  ・統合リスク分析  │   │
│  │  ・規制資本分析    │  │  ・バーゼル規制    │  │  ・レポート作成    │   │
│  └────────────────────┘  └────────────────────┘  └────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 🔑 主要コンポーネント

| コンポーネント | 役割 | 本デモでの再現 |
|:---|:---|:---|
| **勘定系システム** | 貸出金明細・取引データ | 統一貸出金明細として模擬 |
| **情報系システム** | 取引先・プロダクト情報 | 統一マスタとして模擬 |
| **内部リスク計測** | EL/UL計算・リスク計測 | 計算結果ファクトとして模擬 |
| **規制資本計算** | RWA計算・バーゼル対応 | 計算結果ファクトとして模擬 |
| **Snowflake Agent** | 統合分析・レポート支援 | Cortex Agent で実装 |

---

## 🏢 想定シナリオ

**架空の金融機関**: 「SnowBank（スノーバンク）」
**対象部門**: リスク管理部（信用リスク管理課）

### ペルソナ
- **利用者**: リスク管理担当者、経営企画部門
- **目的**: 信用リスクの分析・モニタリング、規制対応レポート作成

### ユースケース例
1. 部門別・セグメント別の信用リスクアセット集計
2. EL（期待損失）/UL（非期待損失）の分析
3. 格付別・業種別のエクスポージャー分析
4. 規制資本（RWA）の推移モニタリング
5. 内部管理用リスク指標と規制資本の比較分析
6. リスク管理規程・バーゼル規制の参照

### 💡 デモシナリオ例（部門別信用リスクアセットレポート）

```
【分析要求】
「信用リスク・アセット額を部門別に集計したレポートを作成してほしい」

【Agent 出力】
┌────────────────────────────────────────────────────────────────┐
│ 信用リスクアセット 部門別レポート（2026年1月末時点）            │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│ 【概要】                                                       │
│   総エクスポージャー: 5,234億円                                │
│   信用RWA合計: 2,156億円                                       │
│   リスクウェイト平均: 41.2%                                    │
│                                                                │
│ 【部門別内訳】                                                 │
│   ┌─────────────┬──────────────┬─────────────┬──────────┐      │
│   │ 部門        │ エクスポージャー│ 信用RWA     │ RW平均   │      │
│   ├─────────────┼──────────────┼─────────────┼──────────┤      │
│   │ 法人営業第一│ 1,523億円    │ 684億円     │ 44.9%    │      │
│   │ 法人営業第二│ 1,245億円    │ 498億円     │ 40.0%    │      │
│   │ 中小企業営業│ 892億円      │ 445億円     │ 49.9%    │      │
│   │ 国際営業    │ 856億円      │ 342億円     │ 40.0%    │      │
│   │ 個人営業    │ 718億円      │ 187億円     │ 26.0%    │      │
│   └─────────────┴──────────────┴─────────────┴──────────┘      │
│                                                                │
│ 【リスク分析】                                                 │
│   ・法人営業第一部門のRWが高い（格付低下案件あり）              │
│   ・個人営業はリテール扱いでRW低減                             │
│                                                                │
│ 【内部管理指標との比較】                                       │
│   内部EL合計: 45.2億円                                         │
│   内部UL合計: 123.4億円                                        │
│   規制資本との差異: +12.3億円（保守的設定）                     │
└────────────────────────────────────────────────────────────────┘
```

---

## 📊 データモデル設計

### テーブル構成

| テーブル名 | 件数 | 用途 |
|:---|:---|:---|
| **DIM_COUNTERPARTY** | 500件 | 取引先マスタ（法人・個人、格付、業種） |
| **DIM_PRODUCT** | 30件 | プロダクトマスタ（貸出、コミットメントライン等） |
| **DIM_DEPARTMENT** | 20件 | 部門マスタ（営業部門、管理部門） |
| **DIM_RATING** | 15件 | 格付マスタ（内部格付、外部格付対応） |
| **DIM_INDUSTRY** | 30件 | 業種マスタ（日銀業種分類） |
| **FACT_LOAN_DETAIL** | 3000件 | 貸出金明細ファクト（統一データ） |
| **FACT_INTERNAL_RISK** | 3000件 | 内部リスク計測結果（EL/UL） |
| **FACT_REGULATORY_RISK** | 3000件 | 規制資本計算結果（RWA） |
| **RISK_DOCUMENT** | 40件 | リスク管理ドキュメント（規程、バーゼル解説） |

### 格付マスタ（15件）

| 格付コード | 格付名 | PD区分 | 説明 |
|:---|:---|:---|:---|
| AAA | トリプルA | 0.01% | 最優良 |
| AA | ダブルA | 0.02% | 優良 |
| A | シングルA | 0.05% | 良好 |
| BBB | トリプルB | 0.20% | 投資適格下限 |
| BB | ダブルB | 1.00% | 投機的 |
| B | シングルB | 3.00% | 高リスク |
| CCC | トリプルC | 10.00% | 要注意 |
| CC | ダブルC | 20.00% | 破綻懸念 |
| D | デフォルト | 100.00% | 破綻 |

### 業種マスタ（30件・主要業種）

- 製造業（食品、化学、鉄鋼、電機、自動車、その他）
- 建設業
- 不動産業
- 卸売・小売業
- 運輸・通信業
- 金融・保険業
- サービス業
- 医療・福祉
- 電気・ガス
- 政府・地方公共団体
- 個人（住宅ローン、その他）

### ER図（リレーション）

```
DIM_COUNTERPARTY ──────┐
      │                │ COUNTERPARTY_KEY
      │ RATING_KEY     ▼
      ▼          FACT_LOAN_DETAIL ◄────── DIM_PRODUCT
DIM_RATING              │                    (PRODUCT_KEY)
                        │ DEPARTMENT_KEY
DIM_INDUSTRY ◄──────────┤                    
  (INDUSTRY_KEY)        ▼
                  DIM_DEPARTMENT

FACT_LOAN_DETAIL ──────┐
                       │ LOAN_KEY
                       ▼
              FACT_INTERNAL_RISK
                       │
                       ▼
              FACT_REGULATORY_RISK
```

---

## 🛠️ 作成物一覧

### 1. SQL スクリプト: `risk_setup.sql`

| セクション | 内容 |
|:---|:---|
| 1. ロール・ウェアハウス設定 | ACCOUNTADMIN、SNOW_RISK_WH 作成 |
| 2. データベース・スキーマ作成 | SNOW_RISK.DATA、SNOW_RISK.AI |
| 3. テーブル作成（DDL） | 9テーブルの定義 |
| 4. サンプルデータ投入 | 日本語サンプルデータ |
| 5. Semantic View 作成 | SV_INTERNAL_RISK（内部リスク分析用）、SV_REGULATORY_RISK（規制資本分析用） |
| 6. Cortex Search Service 作成 | RISK_DOCUMENTS_CSS |
| 7. Cortex Agent 作成 | RISK_MANAGEMENT_AGENT |
| 8. 検証 | データ件数・オブジェクト確認 |
| 9. 権限付与 | 他ロールへの権限付与（コメントアウト） |

### 2. ドキュメント

| ファイル名 | 内容 |
|:---|:---|
| `README.md` | セットアップ手順、アーキテクチャ説明 |
| `er_diagram_risk.html` | ER図（ブラウザ表示用） |

---

## 📄 RISK_DOCUMENT の内容（案）

リスク管理業務に必要なドキュメントを40件程度用意：

### リスク管理規程（10件程度）
- 信用リスク管理方針
- 信用リスク計量化ルール
- 格付制度運用細則
- 与信限度額管理規程
- 大口与信管理要領
- 信用リスク報告体制
- 自己査定実施要領
- 貸倒引当金計上基準
- ストレステスト実施要領
- リスクアペタイト方針

### バーゼル規制解説（15件程度）
- バーゼルIII概要
- 信用リスクの標準的手法
- 信用リスクの内部格付手法（IRB）
- リスクウェイト算出方法
- 信用リスク削減手法（CRM）
- エクスポージャー区分の定義
- PD/LGD/EADの定義と計算
- 期待損失（EL）と非期待損失（UL）
- 自己資本比率規制
- レバレッジ比率規制
- 大口エクスポージャー規制
- カウンターパーティ信用リスク
- CVA（信用評価調整）リスク
- 開示規制（Pillar 3）
- バーゼルIIIファイナライズ

### 業務マニュアル（10件程度）
- 月次リスクレポート作成手順
- 日次リスクモニタリング手順
- 格付見直しプロセス
- 異常値検知対応フロー
- データ品質管理ルール
- システム間データ連携仕様
- 部門別配賦計算方法
- 経営報告資料作成ガイド
- 監査対応準備チェックリスト
- BCP対応手順（リスク管理）

### 用語集・参照資料（5件程度）
- 信用リスク用語集
- 金融庁告示早見表
- 日銀業種分類対応表
- 外部格付対応表
- 主要指標計算式一覧

---

## 🤖 Cortex Agent 設計

### Agent名
`RISK_MANAGEMENT_AGENT`

### ツール構成

| ツール名 | 種別 | 用途 |
|:---|:---|:---|
| **InternalRiskAnalyst** | cortex_analyst_text_to_sql | 内部リスク計測データの分析（EL/UL） |
| **RegulatoryRiskAnalyst** | cortex_analyst_text_to_sql | 規制資本データの分析（RWA） |
| **RiskDocumentSearch** | cortex_search | 規程・バーゼル規制・マニュアルの検索 |

### 質問例

#### 内部リスク分析（InternalRiskAnalyst）
- 「部門別のEL（期待損失）を集計して」
- 「格付別のエクスポージャー分布を見せて」
- 「業種別のUL（非期待損失）ランキングを教えて」
- 「PD区分ごとの貸出残高を集計して」
- 「先月からELが増加した部門を特定して」

#### 規制資本分析（RegulatoryRiskAnalyst）
- 「部門別の信用RWAを集計して」
- 「リスクウェイト別のエクスポージャー分布を見せて」
- 「エクスポージャー区分ごとのRWAを教えて」
- 「規制資本の推移を月次で集計して」
- 「大口エクスポージャーの状況を確認して」

#### ドキュメント検索（RiskDocumentSearch）
- 「内部格付手法のPD推計方法を教えて」
- 「リスクウェイトの算出ルールは？」
- 「信用リスク削減手法として認められるものは？」
- 「月次リスクレポートの作成手順を教えて」
- 「格付見直しのトリガー条件は？」

#### 複合分析
- 「部門別の信用リスクアセットを集計し、リスクウェイトが高い理由を分析して」
- 「内部管理指標と規制資本の乖離要因を説明して」

---

## 📊 主要指標の定義

### 内部管理指標

| 指標 | 定義 | 計算式 |
|:---|:---|:---|
| **EL（期待損失）** | 期待される平均的な損失 | EAD × PD × LGD |
| **UL（非期待損失）** | 期待損失を上回る予想外の損失 | 信頼区間に基づく計算 |
| **PD（デフォルト確率）** | 1年以内にデフォルトする確率 | 格付に対応 |
| **LGD（デフォルト時損失率）** | デフォルト時の損失割合 | 担保・保証を考慮 |
| **EAD（デフォルト時エクスポージャー）** | デフォルト時の与信残高 | オフバランス含む |

### 規制資本指標

| 指標 | 定義 | 計算式 |
|:---|:---|:---|
| **信用RWA** | 信用リスクアセット | EAD × リスクウェイト |
| **リスクウェイト** | 資本算入率 | 標準的手法またはIRB |
| **自己資本比率** | 規制上の健全性指標 | 自己資本 ÷ RWA |

---

## 📋 作業ステップ

### Phase 1: 基盤構築
- [ ] データベース・スキーマ作成
- [ ] テーブルDDL作成（9テーブル）
- [ ] サンプルデータ投入（貸出明細3000件）

### Phase 2: AI コンポーネント
- [ ] Semantic View 作成（内部リスク用・規制資本用）
- [ ] Cortex Search Service 作成
- [ ] Cortex Agent 作成

### Phase 3: ドキュメント整備
- [ ] README.md 作成
- [ ] ER図（HTML）作成
- [ ] 質問例・デモシナリオ整備

### Phase 4: テスト・調整
- [ ] 各コンポーネントの動作確認
- [ ] 質問応答の精度確認
- [ ] 必要に応じて Verified Query 追加

---

## ⚙️ 環境設定（予定）

| 項目 | 値 |
|:---|:---|
| **DATABASE** | `SNOW_RISK` |
| **SCHEMA（データ）** | `DATA` |
| **SCHEMA（AI）** | `AI` |
| **WAREHOUSE** | `SNOW_RISK_WH` |
| **ROLE** | `ACCOUNTADMIN` |

---

## 🎯 お客様課題への対応

本デモは以下のお客様課題を解決します：

| 課題 | Snowflakeによる解決策 |
|:---|:---|
| 同じデータを各システムで重複保持 | 統一マスタ・ファクトで一元管理 |
| 同一データの特定ができない | COUNTERPARTY_KEY等の統一キーで紐づけ |
| クレンジング・加工作業の重複 | 単一のソースデータから両システム用データを生成 |
| 部門情報の紐づけが困難 | DIM_DEPARTMENTで部門情報を一元管理 |
| レポート作成の即時性・柔軟性が欠如 | Cortex Agentによる自然言語分析 |
| 作業が自動化できない | Semantic Viewによる定型レポート自動化 |

---

## 📝 備考

- Payment_Service（SnowCredit）、Call_Center（SnowBank）と同じリポジトリ構成を踏襲
- 日本語データ・日本語対応を前提とする
- デモ用のサンプルデータのため、実際の顧客情報は含まない
- **内部管理用リスク**: EL/UL計算結果を格納
- **規制資本用リスク**: RWA計算結果を格納
- **Cortex Agent**: 両方のデータを統合的に分析可能
